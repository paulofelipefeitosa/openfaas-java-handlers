---
title: "Merge Data"
author: "Paulo Feitosa"
date: "August 28, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(dplyr)
```

## Pure Startup

### Java

```{r JavaPureStartup}
nocriu_nobpf_nowarm_java <- read.csv("java/nocriu_nobpftrace_nogc_nowarmup.csv")
nocriu_nobpf_nowarm_java$Runtime <- "Java"
nocriu_nobpf_nowarm_java$Technique <- "Vanilla"

criu_nobpf_nowarm_java <- read.csv("java/criu_nobpftrace_nogc_nowarmup.csv")
criu_nobpf_nowarm_java$Runtime <- "Java"
criu_nobpf_nowarm_java$Technique <- "Prebaking"

criu_nobpf_warm_java <- read.csv("java/criu_nobpftrace_nogc_warmup.csv")
criu_nobpf_warm_java$Runtime <- "Java"
criu_nobpf_warm_java$Technique <- "Prebaking Warm"

java_nobpf <- rbind(nocriu_nobpf_nowarm_java, criu_nobpf_nowarm_java, criu_nobpf_warm_java)
```

### NodeJS

#### NoOp

```{r NodeJSNOOPPureStartup}
nocriu_nobpf_nowarm_node_noop <- read.csv("node/server-http-handler-nodejs-no-criu-noop-1566334496-300-300--.csv")
nocriu_nobpf_nowarm_node_noop$App <- "NoOp"
nocriu_nobpf_nowarm_node_noop$Runtime <- "NodeJS"
nocriu_nobpf_nowarm_node_noop$Technique <- "Vanilla"

criu_nobpf_nowarm_node_noop <- read.csv("node/server-http-handler-nodejs-criu-noop-1566338922-300-300--.csv")
criu_nobpf_nowarm_node_noop$App <- "NoOp"
criu_nobpf_nowarm_node_noop$Runtime <- "NodeJS"
criu_nobpf_nowarm_node_noop$Technique <- "Prebaking"

criu_nobpf_warm_node_noop <- read.csv("node/server-http-handler-nodejs-criu-noop-1566335023-300-300-YES-.csv")
criu_nobpf_warm_node_noop$App <- "NoOp"
criu_nobpf_warm_node_noop$Runtime <- "NodeJS"
criu_nobpf_warm_node_noop$Technique <- "Prebaking Warm"
```

#### Thumbnailator

```{r NodeJSThumbPureStartup}
nocriu_nobpf_nowarm_node_thumb <- read.csv("node/server-http-handler-nodejs-no-criu-thumbnailator-1566334552-300-300--.csv")
nocriu_nobpf_nowarm_node_thumb$App <- "Thumbnailator"
nocriu_nobpf_nowarm_node_thumb$Runtime <- "NodeJS"
nocriu_nobpf_nowarm_node_thumb$Technique <- "Vanilla"

criu_nobpf_nowarm_node_thumb <- read.csv("node/server-http-handler-nodejs-criu-thumbnailator-1566339435-300-300--.csv")
criu_nobpf_nowarm_node_thumb$App <- "Thumbnailator"
criu_nobpf_nowarm_node_thumb$Runtime <- "NodeJS"
criu_nobpf_nowarm_node_thumb$Technique <- "Prebaking"

criu_nobpf_warm_node_thumb <- read.csv("node/server-http-handler-nodejs-criu-thumbnailator-1566336452-300-300-YES-.csv")
criu_nobpf_warm_node_thumb$App <- "Thumbnailator"
criu_nobpf_warm_node_thumb$Runtime <- "NodeJS"
criu_nobpf_warm_node_thumb$Technique <- "Prebaking Warm"
```

```{r mergeNodeJs}
node_nobpf <- rbind(nocriu_nobpf_nowarm_node_noop, nocriu_nobpf_nowarm_node_thumb, criu_nobpf_nowarm_node_noop, criu_nobpf_nowarm_node_thumb, criu_nobpf_warm_node_noop, criu_nobpf_warm_node_thumb)
```

### Python

#### NoOp

```{r PythonNOOPPureStartup}
nocriu_nobpf_nowarm_python_noop <- read.csv("python/flask/server-http-handler-python-no-criu-noop-1567793204-300-300---.csv")
nocriu_nobpf_nowarm_python_noop$App <- "NoOp"
nocriu_nobpf_nowarm_python_noop$Runtime <- "Python"
nocriu_nobpf_nowarm_python_noop$Technique <- "Vanilla"

criu_nobpf_nowarm_python_noop <- read.csv("python/flask/server-http-handler-python-criu-noop-1567795924-300-300---.csv")
criu_nobpf_nowarm_python_noop$App <- "NoOp"
criu_nobpf_nowarm_python_noop$Runtime <- "Python"
criu_nobpf_nowarm_python_noop$Technique <- "Prebaking"

criu_nobpf_warm_python_noop <- read.csv("python/flask/server-http-handler-python-criu-noop-1568640415-300-300-YES--.csv")
criu_nobpf_warm_python_noop$App <- "NoOp"
criu_nobpf_warm_python_noop$Runtime <- "Python"
criu_nobpf_warm_python_noop$Technique <- "Prebaking Warm"
```

#### Thumbnailator

```{r PythonThumbPureStartup}
nocriu_nobpf_nowarm_python_thumb <- read.csv("python/flask/server-http-handler-python-no-criu-thumbnailator-1567793304-300-300---.csv")
nocriu_nobpf_nowarm_python_thumb$App <- "Thumbnailator"
nocriu_nobpf_nowarm_python_thumb$Runtime <- "Python"
nocriu_nobpf_nowarm_python_thumb$Technique <- "Vanilla"

criu_nobpf_nowarm_python_thumb <- read.csv("python/flask/server-http-handler-python-criu-thumbnailator-1567796648-300-300---.csv")
criu_nobpf_nowarm_python_thumb$App <- "Thumbnailator"
criu_nobpf_nowarm_python_thumb$Runtime <- "Python"
criu_nobpf_nowarm_python_thumb$Technique <- "Prebaking"

criu_nobpf_warm_python_thumb <- read.csv("python/flask/server-http-handler-python-criu-thumbnailator-1568641413-300-300-YES--.csv")
criu_nobpf_warm_python_thumb$App <- "Thumbnailator"
criu_nobpf_warm_python_thumb$Runtime <- "Python"
criu_nobpf_warm_python_thumb$Technique <- "Prebaking Warm"
```

```{r mergePython}
python_nobpf <- rbind(nocriu_nobpf_nowarm_python_noop, nocriu_nobpf_nowarm_python_thumb, criu_nobpf_nowarm_python_noop, criu_nobpf_nowarm_python_thumb, criu_nobpf_warm_python_noop, criu_nobpf_warm_python_thumb)
```

```{r finalmerge}
nobpf_startup <- rbind(java_nobpf, 
                       node_nobpf %>%
                         rename("Value_NS" = "KernelTime_NS"), 
                       python_nobpf %>%
                         rename("Value_NS" = "KernelTime_NS"))
write.csv(nobpf_startup, 
  file = "startup_nobpftrace.csv",
  row.names = FALSE)
```

## Bpftrace Startup

### Java

```{r java_bpfstartup}
nocriu_bpf_nowarm_java <- read.csv("java/nocriu_newbpftrace_nogc_nowarmup.csv")
nocriu_bpf_nowarm_java$Runtime <- "Java"
nocriu_bpf_nowarm_java$Technique <- "Vanilla"

criu_bpf_nowarm_java <- read.csv("java/criu_bpftrace_nogc_nowarmup.csv")
criu_bpf_nowarm_java$Runtime <- "Java"
criu_bpf_nowarm_java$Technique <- "Prebaking"

criu_bpf_warm_java <- read.csv("java/criu_bpftrace_gc_warmup.csv")
criu_bpf_warm_java$Runtime <- "Java"
criu_bpf_warm_java$Technique <- "Prebaking Warm"

java_bpf <- rbind(nocriu_bpf_nowarm_java, criu_bpf_nowarm_java, criu_bpf_warm_java)
```

### NodeJS

#### NoOp

```{r NodeJSNOOP_bpfstartup}
nocriu_bpf_nowarm_node_noop <- read.csv("node/server-http-handler-nodejs-no-criu-noop-1566340457-300-300---bpftrace.csv")
nocriu_bpf_nowarm_node_noop$App <- "NoOp"
nocriu_bpf_nowarm_node_noop$Runtime <- "NodeJS"
nocriu_bpf_nowarm_node_noop$Technique <- "Vanilla"

criu_bpf_nowarm_node_noop <- read.csv("node/server-http-handler-nodejs-criu-noop-1567606428-300-2---YES.csv")
criu_bpf_nowarm_node_noop$App <- "NoOp"
criu_bpf_nowarm_node_noop$Runtime <- "NodeJS"
criu_bpf_nowarm_node_noop$Technique <- "Prebaking"

criu_bpf_warm_node_noop <- read.csv("node/server-http-handler-nodejs-criu-noop-1566342218-300-300-YES--bpftrace.csv")
criu_bpf_warm_node_noop$App <- "NoOp"
criu_bpf_warm_node_noop$Runtime <- "NodeJS"
criu_bpf_warm_node_noop$Technique <- "Prebaking Warm"
```

#### Thumbnailator

```{r NodeJSThumb_bpfstartup}
nocriu_bpf_nowarm_node_thumb <- read.csv("node/server-http-handler-nodejs-no-criu-thumbnailator-1566341128-300-300---bpftrace.csv")
nocriu_bpf_nowarm_node_thumb$App <- "Thumbnailator"
nocriu_bpf_nowarm_node_thumb$Runtime <- "NodeJS"
nocriu_bpf_nowarm_node_thumb$Technique <- "Vanilla"

criu_bpf_nowarm_node_thumb <- read.csv("node/server-http-handler-nodejs-criu-thumbnailator-1567470629-300-2---YES.csv")
criu_bpf_nowarm_node_thumb$App <- "Thumbnailator"
criu_bpf_nowarm_node_thumb$Runtime <- "NodeJS"
criu_bpf_nowarm_node_thumb$Technique <- "Prebaking"

criu_bpf_warm_node_thumb <- read.csv("node/server-http-handler-nodejs-criu-thumbnailator-1566344628-300-300-YES--bpftrace.csv")
criu_bpf_warm_node_thumb$App <- "Thumbnailator"
criu_bpf_warm_node_thumb$Runtime <- "NodeJS"
criu_bpf_warm_node_thumb$Technique <- "Prebaking Warm"
```

```{r mergeNodeJs_bpfstartup}
node_bpf <- rbind(nocriu_bpf_nowarm_node_noop, nocriu_bpf_nowarm_node_thumb, criu_bpf_nowarm_node_noop, criu_bpf_nowarm_node_thumb, criu_bpf_warm_node_noop, criu_bpf_warm_node_thumb)
```

### Python

#### NoOp

```{r PythonNOOP_bpfstartup}
nocriu_bpf_nowarm_python_noop <- read.csv("python/flask/server-http-handler-python-no-criu-noop-1568644963-300-2---YES.csv")
nocriu_bpf_nowarm_python_noop$App <- "NoOp"
nocriu_bpf_nowarm_python_noop$Runtime <- "Python"
nocriu_bpf_nowarm_python_noop$Technique <- "Vanilla"

criu_bpf_nowarm_python_noop <- read.csv("python/flask/server-http-handler-python-criu-noop-1568646330-300-2---YES.csv")
criu_bpf_nowarm_python_noop$App <- "NoOp"
criu_bpf_nowarm_python_noop$Runtime <- "Python"
criu_bpf_nowarm_python_noop$Technique <- "Prebaking"

criu_bpf_warm_python_noop <- read.csv("python/flask/server-http-handler-python-criu-noop-1568648955-300-2-YES--YES.csv")
criu_bpf_warm_python_noop$App <- "NoOp"
criu_bpf_warm_python_noop$Runtime <- "Python"
criu_bpf_warm_python_noop$Technique <- "Prebaking Warm"
```

#### Thumbnailator

```{r PythonThumb_bpfstartup}
nocriu_bpf_nowarm_python_thumb <- read.csv("python/flask/server-http-handler-python-no-criu-thumbnailator-1568645634-300-2---YES.csv")
nocriu_bpf_nowarm_python_thumb$App <- "Thumbnailator"
nocriu_bpf_nowarm_python_thumb$Runtime <- "Python"
nocriu_bpf_nowarm_python_thumb$Technique <- "Vanilla"

criu_bpf_nowarm_python_thumb <- read.csv("python/flask/server-http-handler-python-criu-thumbnailator-1568647626-300-2---YES.csv")
criu_bpf_nowarm_python_thumb$App <- "Thumbnailator"
criu_bpf_nowarm_python_thumb$Runtime <- "Python"
criu_bpf_nowarm_python_thumb$Technique <- "Prebaking"

criu_bpf_warm_python_thumb <- read.csv("python/flask/server-http-handler-python-criu-thumbnailator-1568650553-300-2-YES--YES.csv")
criu_bpf_warm_python_thumb$App <- "Thumbnailator"
criu_bpf_warm_python_thumb$Runtime <- "Python"
criu_bpf_warm_python_thumb$Technique <- "Prebaking Warm"
```

```{r mergePython_bpfstartup}
python_bpf <- rbind(nocriu_bpf_nowarm_python_noop, nocriu_bpf_nowarm_python_thumb, criu_bpf_nowarm_python_noop, criu_bpf_nowarm_python_thumb, criu_bpf_warm_python_noop, criu_bpf_warm_python_thumb)
```

```{r bpftrace_data_treatment}
require(dplyr)
require(reshape2)

read_bpftrace_pure_data <- function(df) {
  
  evaluate <- function(df, v1, v2, is_pb=FALSE, v3_opt=NA) {
    if (is_pb) {
      if (!is.na(v3_opt) && length(v1) == 1 && length(v3_opt) == 1) {
        return(df[v1] - df[v3_opt])
      } else {
        return(NA)
      }
    } else {
      if (length(v1) == 1 && length(v2) == 1) {
        return(df[v1] - df[v2])
      } else {
        return(NA)
      }
    }
  }
  
  return (df %>%
      group_by(Technique, Runtime, App, ExecID, ReqID) %>%
      summarise(
        CloneTime = evaluate(Value_NS, which(Metric == "CloneExit"), which(Metric == "CloneEntry")),
        ExecTime = evaluate(Value_NS, which(Metric == "ExecveExit"), which(Metric == "CloneExit")),
        RuntimeTime = evaluate(Value_NS, 
                               which(Metric == "MainEntry"), 
                               which(Metric == "ExecveExit"), 
                               grepl("^Prebaking", unique(Technique))),
        InitializationTime = evaluate(Value_NS, 
                                      which(Metric == "Ready2Serve"), 
                                      which(Metric == "MainEntry"), 
                                      grepl("^Prebaking", unique(Technique)), 
                                      which(Metric == "ExecveExit"))) %>%
      melt(id.vars = c("Technique", "Runtime", "App", "ExecID", "ReqID"), 
           measure.vars = c("CloneTime", "ExecTime", "RuntimeTime", "InitializationTime")) %>%
      rename("Metric" = "variable", "Value_NS" = "value"))
}

read_startup_bpfstrace <- function(df) {
  df <- df %>% rename("Value" = "Value_NS") %>% filter(!is.na(Value))
  df$Value <- df$Value / 10^6

  ct <- df %>% filter(Metric == "CloneTime")
  ct$Metric <- "CLONE"
  et <- df %>% filter(Metric == "ExecTime")
  et$Metric <- "EXEC"
  it <- df %>% filter(Metric == "InitializationTime")
  it$Metric <- "APPINIT"
  rt <- df %>% filter(Metric == "RuntimeTime")
  rt$Metric <- "RTS"
  return(rbind(ct, et, rt, it))
}

```

```{r merge_bpfstartup}
startup_bpftrace <- rbind(java_bpf, 
                          node_bpf %>% 
                            rename("Value_NS" = "KernelTime_NS") %>%
                            filter(ReqID < 2), 
                          python_bpf %>% 
                            rename("Value_NS" = "KernelTime_NS") %>%
                            filter(ReqID < 2))

write.csv(startup_bpftrace, 
  file = "new_startup_bpftrace.csv",
  row.names = FALSE)

pure_bpftrace_startup <- startup_bpftrace %>% 
  mutate(App = replace(App, App == "NoOp", "NOOP")) %>% 
  mutate(App = replace(App, App == "Thumbnailator", "Thumbnail Maker"))

bpftrace_startup <- read_startup_bpfstrace(
  rbind(pure_bpftrace_startup %>% filter(Runtime == "Java"),
        read_bpftrace_pure_data(pure_bpftrace_startup %>% filter(Runtime != "Java" & ReqID == 0))))

write.csv(bpftrace_startup,
          file = "treated_startup_bpftrace.csv",
          row.names = FALSE)
```
